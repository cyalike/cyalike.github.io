// ===== ç‹€æ…‹ =====
const state = {
  places: [],
  markers: new Map(),
  query: "",
  currentTag: ""
};

const $ = (s) => document.querySelector(s);

// ===== å·¥å…· =====
function normalize(s) {
  return (s || "").toString().toLowerCase().trim();
}

function matches(place, q, tag) {
  const text = normalize(q);
  const tagOk = !tag || (place.tags || []).includes(tag);

  if (!text) return tagOk;

  const hay = [
    place.name,
    place.address,
    (place.tags || []).join(" "),
    place.notes
  ].map(normalize).join(" ");

  return tagOk && hay.includes(text);
}

function filteredPlaces() {
  return state.places.filter(p => matches(p, state.query, state.currentTag));
}

// ===== å³é‚Šæ¸…å–® =====
function renderTagOptions(places) {
  const tags = new Set();
  places.forEach(p => (p.tags || []).forEach(t => tags.add(t)));

  const select = $("#tagFilter");
  select.innerHTML =
    `<option value="">æ‰€æœ‰æ¨™ç±¤</option>` +
    [...tags].sort().map(t => `<option value="${t}">${t}</option>`).join("");
}

function placeCard(place) {
  const tags = (place.tags || []).map(t => `<span class="tag">${t}</span>`).join("");

  const mustTry = (place.mustTry && place.mustTry.length)
    ? `<div class="meta">ğŸ˜‹ ${place.mustTry.join("ã€")}</div>`
    : "";

  const seating = place.seating ? `<div class="meta">ğŸª‘ ä½å­ï¼š${place.seating}</div>` : "";
  const toilet = place.toilet ? `<div class="meta">ğŸš» å»æ‰€ï¼š${place.toilet}</div>` : "";
  const hours = place.hours ? `<div class="meta">ğŸ•’ ${place.hours}</div>` : "";
  const revisit = place.revisit ? `<div class="meta">ğŸ” ${place.revisit}</div>` : "";

  // â—ä¸é¡¯ç¤ºã€Œå‚™è¨»ã€å…©å­—ï¼Œåªé¡¯ç¤ºä½ å¯«çš„å…§å®¹
  const notes = place.notes ? `<div class="meta">${place.notes}</div>` : "";

  return `
    <div class="card" data-id="${place.id}">
      <h3>${place.name}</h3>
      ${mustTry}
      ${seating}
      ${toilet}
      ${hours}
      ${revisit}
      ${notes}
      ${place.address ? `<div class="meta">ğŸ“ ${place.address}</div>` : ""}
      <div class="tags">${tags}</div>
    </div>
  `;
}

// ===== åœ°åœ– popupï¼ˆåªç•™æœ€åŸºæœ¬ï¼‰=====
function popupHtml(place) {
  const addr = place.address
    ? `<div style="margin-top:6px;font-size:12px;opacity:.8">ğŸ“ ${place.address}</div>`
    : "";

  return `
    <div style="min-width:220px">
      <div style="font-weight:700;font-size:14px">${place.name}</div>
      ${addr}
    </div>
  `;
}

// ===== åŒæ­¥æ¸…å–®èˆ‡åœ°åœ– =====
function syncListAndMarkers(map) {
  const list = $("#list");
  const shown = filteredPlaces();

  $("#count").textContent = `${shown.length} / ${state.places.length}`;
  list.innerHTML = shown.map(placeCard).join("");

  for (const p of state.places) {
    const m = state.markers.get(p.id);
    if (!m) continue;
    const shouldShow = shown.some(x => x.id === p.id);
    if (shouldShow && !map.hasLayer(m)) m.addTo(map);
    if (!shouldShow && map.hasLayer(m)) map.removeLayer(m);
  }

  list.querySelectorAll(".card").forEach(card => {
    card.addEventListener("click", () => {
      const id = card.dataset.id;
      const place = state.places.find(p => p.id === id);
      const marker = state.markers.get(id);
      if (!place || !marker) return;
      map.flyTo([place.lat, place.lng], 16, { duration: 0.8 });
      marker.openPopup();
    });
  });
}

// ===== ä¸»ç¨‹å¼ =====
async function main() {
  const res = await fetch("places.json", { cache: "no-store" });
  const places = await res.json();

  state.places = places.filter(
    p => p && p.id && p.name && typeof p.lat === "number" && typeof p.lng === "number"
  );

  renderTagOptions(state.places);

  // ğŸ”¥ é«˜é›„é è¨­
  const map = L.map("map").setView([22.6273, 120.3014], 13);

  // ğŸ”¥ ä¹¾æ·¨åº•åœ–ï¼ˆè¼”åŠ©ç”¨ï¼‰
  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
    {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap & CARTO"
    }
  ).addTo(map);

  for (const p of state.places) {
    const m = L.marker([p.lat, p.lng]).bindPopup(popupHtml(p));
    state.markers.set(p.id, m);
    m.addTo(map);
  }

  $("#search").addEventListener("input", e => {
    state.query = e.target.value;
    syncListAndMarkers(map);
  });

  $("#tagFilter").addEventListener("change", e => {
    state.currentTag = e.target.value;
    syncListAndMarkers(map);
  });

  syncListAndMarkers(map);
}

main();
